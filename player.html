<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Playing Movie</title>
  <style>
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #backBtn {
      background: #444;
      color: #fff;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }
    #backBtn:hover {
      background: #666;
    }
    iframe, video {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="backBtn" onclick="window.history.back()">‚Üê Back to Movies</div>
  <div id="playerContainer"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get("url");

    function isM3U8(url) {
      return url.includes(".m3u8");
    }

    function isMP4(url) {
      return url.includes(".mp4");
    }

    function isTXT(url) {
      return url.includes(".txt");
    }

    async function fetchFromTxt(txtUrl) {
      const response = await fetch(txtUrl);
      const content = await response.text();
      const lines = content.split("\n");
      const lastLine = lines.reverse().find(line => line.includes(".m3u8") || line.includes(".mp4"));
      return lastLine || null;
    }

    async function loadVideo() {
      if (!videoUrl) return;

      let finalUrl = videoUrl;

      if (isTXT(videoUrl)) {
        finalUrl = await fetchFromTxt(videoUrl);
      }

      if (!finalUrl) {
        document.body.innerHTML = "<h2 style='color:white;text-align:center'>Video not found.</h2>";
        return;
      }

      const videoElement = document.createElement("video");
      videoElement.src = finalUrl;
      videoElement.controls = true;
      videoElement.autoplay = true;

      if (isM3U8(finalUrl)) {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/hls.js@latest";
        script.onload = () => {
          if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(finalUrl);
            hls.attachMedia(videoElement);
          } else if (videoElement.canPlayType("application/vnd.apple.mpegurl")) {
            videoElement.src = finalUrl;
          }
        };
        document.body.appendChild(script);
      }

      document.getElementById("playerContainer").appendChild(videoElement);
    }

    loadVideo();
  </script>
</body>
</html>
